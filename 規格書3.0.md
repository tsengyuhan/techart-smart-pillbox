# 💊 ESP32-S3 智慧藥盒系統規格書 V3.0
> 最後更新：2026-02-17

---

## 1. 系統概述

照顧者預先設定好出藥時間並放入藥杯，老人只需在固定時間到藥盒取藥。系統自動出藥、監控取藥狀態，並透過網頁 APP 提供照顧者即時監控與歷史紀錄。

### 使用者角色
| 角色 | 操作內容 |
|------|---------|
| **老人** | 到時間取藥，無需任何按鍵操作 |
| **照顧者** | 設定鬧鐘、補藥、透過網頁監控狀態與歷史紀錄 |

---

## 2. 硬體結構


### 核心硬體規格

* **主控制器**：ESP32-S3 DevKit
* **電源供應**：DC 24V / 5A (步進馬達供電)（電流需再確認，但2A不夠）
* **通訊協定**：Wi-Fi (2.4GHz) + Firebase Realtime Database
* **時間同步**：NTP Server (pool.ntp.org)
* **控制邏輯**：
    *   **雙核心**：Core 0 負責 WiFi/Firebase 通訊，Core 1 負責馬達與感測器掃描。
    *   **阻塞式動作**：馬達移動時暫停指令接收。
  

### 空間配置
```
蓋子（上層）
  ├── 出藥孔（1個，固定位置）
  └── 藥杯凹槽（5個，含五點位置偵測）← 老人吃完後放回空杯

圓盤（下層，可旋轉）
  ├── 位置 0：圓片（待機時封住出藥孔）
  └── 位置 1–5：藥杯槽（順時針排列）

推桿（垂直升降）
  ├── 最低點：圓盤下方（GPIO9 感測）
  ├── 中間：圓片/藥杯與出藥孔齊平（封孔位置）
  └── 推出位置：藥杯推出蓋子上方供老人取藥
  └── 頂端：霍爾感測器（偵測藥杯是否被取走）
```

### 腳位配置

#### 動力系統
| 元件 | GPIO | 類型 | 備註 |
|------|------|------|------|
| 圓盤馬達 M1 脈衝 | 13 | Digital Out | 控制轉動步數 |
| 圓盤馬達 M1 方向 | 14 | Digital Out | 正/反轉 |
| 圓盤馬達 M1 啟用 | 21 | Digital Out | ENA：LOW=鎖定，HIGH=釋放 |
| 推桿馬達 M2 脈衝 | 16 | Digital Out | 控制升降步數 |
| 推桿馬達 M2 方向 | 15 | Digital Out | 上/下 |

#### 感測系統
| 元件 | GPIO | 類型 | 備註 |
|------|------|------|------|
| 圓盤歸零感測器 | 3 | ADC | 光遮斷器，偵測圓盤原點（需轉動幾步校正） |
| 推桿底部感測器 | 9 | ADC | 光遮斷器，確認推桿在最低點 |
| 蓋子五點偵測 | 4 | ADC | 分壓電路，偵測蓋子上哪個位置有空杯 |
| 單點霍爾感測器 | 5 | ADC | 推桿頂端，偵測藥杯是否被取走 |
| 電容觸摸開關 | 8 | Digital In | 觸發補藥模式 |

#### 環境與特效
| 元件 | GPIO | 類型 | 備註 |
|------|------|------|------|
| 散熱風扇 | 10 | Digital Out | 繼電器/MOSFET 控制 |
| DHT22 溫濕度 | 11 | Digital In/Out | |
| LED 燈條 | 12 | Digital Out | 狀態提示 + 氣氛燈 |
| MP3 Player RX | 17 | UART RX | |
| MP3 Player TX | 18 | UART TX | |

---

## 3. 藥杯狀態定義

```
cups[i] = 1  → 有藥杯，藥尚未吃
cups[i] = 0  → 有藥杯，藥已吃完（空杯）
cups[i] = x  → 此位置未放藥杯
```

**重要規則：鬧鐘數量 = 藥杯數量**
- 設定 N 個鬧鐘 → cups[1 ~ N] = 1，cups[ N+1 ~ 5] = x
- 照顧者按鬧鐘排序順序放入藥杯（位置1對應第一個鬧鐘，以此類推）

---

## 4. 安全連鎖規則

### 機械安全規則
```
規則1：推桿確認在最低點（GPIO9 觸發）→ 圓盤才可轉動
規則2：圓盤確認停止轉動 → 推桿才可上升
規則3：開機時 ENA 預設釋放，GPIO9 確認安全後才鎖定馬達
```

### 軟體安全連鎖
```cpp
bool safeToRotate() {
    return GPIO9_SENSOR == TRIGGERED; // 推桿在最低點
}

void rotateDisk(int targetPosition) {
    if (!safeToRotate()) {
        lowerPlungerToBottom();
        waitUntil(GPIO9_TRIGGERED);
    }
    stepperRotate(targetPosition);
}

bool safeToRaise() {
    return diskIsStationary(); // 圓盤已停止
}
```

---

## 5. 系統狀態定義

| 狀態 | 說明 |
|------|------|
| **IDLE（待機）** | 推桿封孔、圓盤在位置0、監聽鬧鐘 |
| **DISPENSING（出藥中）** | 圓盤轉動、推桿推出藥杯 |
| **WAITING（等待取藥）** | 藥杯已推出、霍爾感測器監控中 |
| **REFILL（補藥模式）** | 全機歸零、等待照顧者操作 |
| **ALERT（警告）** | 異常狀態，需照顧者介入 |

---

## 6. 開機流程

```
開機
→ ESP32 啟動
→ Wi-Fi 連線 + NTP 時間同步
→ 讀取 GPIO9（推桿底部感測器）
    ├── 觸發（推桿在最低點）
    │   → 馬達 ENA = LOW（鎖定）
    │   → 執行圓盤歸零（GPIO3校正）
    │   → 推桿上升推圓片封孔
    │   → 進入 IDLE
    │
    └── 未觸發（推桿位置不明）
        → 推桿馬達 ENA = HIGH（釋放，可手動推動）
        → LED 閃爍 + 音效警示
        → 網頁顯示「請確認推桿是否在圓盤下方，確認後按下確認鍵」
        → 等待網頁確認鍵
        → 再次讀取 GPIO9
            ├── 觸發 → 馬達通電 → 繼續歸零流程
            └── 未觸發 → 重複警告
```

---

## 7. 日常出藥流程

```
鬧鐘時間到（NTP）
→ 檢查 cups 是否全為 0 或 x？
    ├── 是（全部發完）
    │   → 播放提示音效
    │   → 網頁顯示「請補藥」
    │   → 結束
    │
    └── 否（還有藥）
        → 檢查此位置是否有「強制回收」記錄？
            └── 有 → 網頁顯示「⚠️ 此藥杯上次未取走，仍繼續出藥」
        
        ↓ 出藥機構啟動
        → [安全確認] 推桿下降到底部（GPIO9確認）
          （此動作將圓片下降放回位置0）
        → 圓盤轉到目標位置（對準出藥孔）
        → 推桿上升推出藥杯
        → 播放提示音效

        ↓ 取藥監控（霍爾感測器）
        → 偵測到藥杯取走持續 5 秒？
            ├── 是
            │   → cups[i] = 0
            │   → log: {date, alarm_time, status: "taken", cup_position}
            │   → 等待蓋子偵測 +1
            │       ├── +1 確認 → ✅ 吃藥完成
            │       └── 未+1 → 網頁顯示蓋子狀態警告
            │
            └── 否（持續計時）
                → 超過 2 分鐘 → 播放提醒音效，繼續等待
                → 超過 3 分鐘 → 強制回收
                    → 推桿下降（藥杯落回原位）
                    → cups[i] 維持 = 1
                    → log: {date, alarm_time, status: "not_taken", cup_position}
                    → 網頁警告「位置X 藥杯未被取走」

        ↓ 歸零封孔（取藥成功或強制回收後）
        → [安全確認] 推桿下降到底部（GPIO9確認）
        → 圓盤歸零（轉回位置0，GPIO3校正）
        → 推桿上升推圓片封孔
        → 進入 IDLE
```

---

## 8. 補藥流程

```
觸發（網頁按鈕 或 電容觸摸開關 GPIO8）
→ [安全確認] 推桿下降到底部（GPIO9確認）
→ 圓盤歸零（轉回位置0）
→ 進入 REFILL 狀態
→ 網頁顯示放藥引導（依鬧鐘排序順序）

照顧者操作：
→ 收走蓋子上所有空藥杯
→ 確認蓋子偵測 = 0
    └── 未歸零 → 網頁提示「還有空杯未收走」
→ 依順序在圓盤放入藥杯
→ 關上蓋子
→ 按下網頁「補藥完成」

系統重置：
→ cups[1~N] = 1，cups[N+1~5] = x（N = 鬧鐘數量）
→ next_cup_index = 1
→ 清除所有強制回收記錄
→ 推桿上升推圓片封孔
→ 進入 IDLE
```

---

## 9. 出藥模式

### 方案 A（不同時間吃不同藥）
- 鬧鐘設定後系統自動排序（最早到最晚）
- 照顧者**依排序順序**放入藥杯（位置1 = 第一個鬧鐘，以此類推）
- 系統依 next_cup_index 順序出藥
- **補藥後從位置1重新開始，鬧鐘時間已過者跳過**

### 方案 B（每次吃相同的藥）
- 方案A完成後再設計
- 差異僅在出藥時「找下一個 cups=1 的位置」，不固定順序

---

## 10. 蓋子監控邏輯

```
蓋子五點偵測：
  偵測每個凹槽位置是否有空杯（位置 + 數量）

比對規則：
  蓋子偵測數量 vs cups=0 的數量
  不符合 → 網頁顯示警告給照顧者
  藥盒本身不做任何動作

吃藥確認條件：
  霍爾感測器偵測藥杯取走（5秒確認）
  + 蓋子偵測數量 +1
  → 判定為該次吃藥完成
```

---

## 11. Firebase 資料路徑

### 監控上傳（ESP32 → Firebase）
```
/pillbox/monitor/
  ├── temp                    溫度（每3秒）
  ├── cups                    圓盤狀態 "x,1,1,0,1,1"
  ├── lid/
  │   ├── positions           蓋子各位置狀態 "0,1,0,1,1"
  │   ├── count               蓋子上偵測到的藥杯數
  │   ├── target              目標藥杯數
  │   └── is_match            是否符合 (true/false)
  ├── hall_sensor             霍爾感測器狀態 (true/false)
  ├── refill_mode             是否在補藥模式 (true/false)
  ├── error_state             系統異常代碼（例如：pusher_stuck, lid_error, cup_not_taken, refill_cups_left, previous_cup_left）
  ├── last_active_cup         當前發生異常或正在發藥的杯子編號（選填）
  └── last_seen               心跳時間戳記
```

### 設定下傳（網頁 → Firebase）
```
/pillbox/config/
  ├── mode                    出藥模式 "A" or "B"
  ├── alarms/
  │   ├── 0: {time:"08:00", cup_position:1}
  │   ├── 1: {time:"12:00", cup_position:2}
  │   └── ...
  ├── alarms_str              鬧鐘字串 "08:00,12:00,18:00"
  └── target_cups             目標藥杯數 (0-5)
```

### 取藥記錄
```
/pillbox/logs/
  └── {timestamp}: {
      date:         "2026-02-17",
      alarm_time:   "08:00",
      status:       "taken" | "not_taken" | "no_cup",
      cup_position: 1
  }
```

### 指令
```
/pillbox/command              手動指令字串
```
*(如：ENTER_REFILL, EXIT_REFILL, CLEAR_ERROR, CLEAR_PUSHER_ERROR)*

---

## 12. 網頁 APP 頁面結構 (SPA 架構)

採用單一網頁應用 (SPA) 與底部導覽列設計，提供類似手機 APP 的操作體驗。

| 頁面/功能 | 存取方式 | 內容與說明 |
|----------|---------|-----------|
| **監控首頁** | 底部導覽列 | 連線狀態、溫度、下一次出藥時間、藥杯狀態、蓋子狀態、霍爾感測<br>包含巨大的「開始補藥」按鈕 |
| **取藥紀錄** | 底部導覽列 | 列表顯示過去三天的取藥紀錄，並提供載入更早紀錄的選項 |
| **出藥時間設定** | 底部導覽列 | 鬧鐘設定（最多5組）、目標藥杯數設定、隱藏的開發者選項入口 |
| **補藥模式** | 首頁大按鈕 | (UI 全螢幕蓋板) 鎖定機器狀態，提示放入藥杯與蓋子，完成後重新待機 |
| **手動控制** | 設定頁底端 | **(需輸入開發者密碼 1234 才能進入)**<br>馬達底層控制、風扇/LED、音效測試、Demo模式 |

---

## 13. Log 記錄架構

```
ESP32 → Firebase /pillbox/logs/
  ↓ GitHub Pages 靜態網頁監聽
  → 自動累積寫入 .txt 持續 log
  → 取藥紀錄分頁供照顧者查詢
  → 提供「匯出 .txt」下載功能
```

---

## 14. 待討論項目

- [ ] 取藥成功後，等待蓋子偵測 +1 的逾時時間設定
- [ ] 方案 B 的完整流程設計
- [x] 網頁 APP 各頁面的詳細 UI/UX 設計 (完成 SPA 架構)
- [ ] GitHub Pages 監聽 Firebase 寫入 .txt 的技術方案確認
- [ ] 蓋子五點偵測的分壓電路對應各位置的數值校正