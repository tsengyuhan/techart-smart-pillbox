# 使用流程圖 (0217) 與網頁 UI 功能比對報告

這份報告分析了「網頁 APP」目前的實作 (`index.html` & `ui.js`) 與「硬體使用流程圖」(`使用流程圖_0217.drawio`) 之間的對應關係，並找出潛在的差異或缺少的 UI 流程。

## 1. 補藥模式流程 (Refill Mode)
**[流程圖定義]**
- 網頁按下「進入補藥模式」或觸碰實體電容開關。
- 推桿下降到底部、圓盤歸零。
- 網頁顯示放藥引導（依鬧鐘順序）。
- 照顧者依序放入藥杯。
- 關上蓋子，按下網頁「補藥完成」。
- 機器封孔並回到待機。若蓋子偵測=0，網頁要提示「還有空杯未收走」。

**[目前 Web UI 實作]**
- **✅ 已實作：** 首頁有「開始補藥」大按鈕。點擊後會有全螢幕黑色蓋板阻止其他操作，顯示「請在對應位置放入新的藥杯，並蓋上蓋子。」並帶有「補藥完成」按鈕。
- **⚠️ 待改進 / 未完全對齊：**
  - 目前的 UI 蓋板只有一句靜態的提示文字，**沒有「依鬧鐘排序順序顯示放藥引導」**。
  - 目前沒有處理「蓋子偵測=0 時，網頁提示『還有空杯未收走』」的警告邏輯。（當按下「補藥完成」時，並沒有阻擋機制或動態字眼）。

## 2. 鬧鐘出藥與取藥監控流程
**[流程圖定義]**
- NTP 鬧鐘時間到。
- 若所有杯子為空或上次未取走：網頁顯示「請補藥」或「此藥杯上次未取走，仍繼續出藥」。
- 推桿下降、圓盤轉動、推桿推起。
- 播放提示音，開始計時。
- **超時未取走（2分鐘）：**播放提醒音效。
- **超時未取走（3分鐘）：**強制回收，網頁警告「位置X 藥杯未被取走」。
- **蓋子狀態異常（超過1分鐘）：**網頁警告蓋子狀態異常。

**[目前 Web UI 實作]**
- **✅ 已實作：** 設定頁面可設定最多 5 組鬧鐘，首頁會顯示下一次出藥時間。首頁有「取藥偵測 (霍爾感測器)」狀態顯示。
- **⚠️ 待改進 / 未完全對齊：**
  - 目前 UI **沒有專門的警告彈跳窗或橫幅**來處理這三種硬體發出的事件：
    1. 「此藥杯上次未取走，仍繼續出藥」
    2. 「位置X 藥杯未被取走」(強制回收)
    3. 「蓋子狀態異常」
  - 這些警告文字目前沒有在 `index.html` 中預留專屬的警告區塊（只有一般的連線狀態與蓋子符合狀態）。
  - 若 Firebase `/pillbox/monitor` 丟出這些錯誤狀態碼，目前的 `ui.js` 尚未實作對應的處理邏輯（例如跳出紅色 `alert` 或顯示置頂 Warning Banner）。

## 3. 開機初始與安全確認流程
**[流程圖定義]**
- 開機時若推桿不在底部（感測器未觸發），網頁要顯示警告：「請確認推桿是否在圓盤下方，確認後按下確認鍵」。
- 網頁要有個確認鍵可以按。

**[目前 Web UI 實作]**
- **❌ 尚未實作：** 目前 `index.html` 沒有任何關於「推桿位置異常需手動確認」的對話框或按鈕。若機器卡在此狀態，使用者無法透過現有的普通介面按下「確認鍵」以繼續開機流程（只能進去隱藏的手動控制區弄）。

## 總結與建議行動

目前的 SPA 網頁架構在「視覺與基本操作（監控、設定、手動控制）」上已經完備，但**在「響應硬體的異常與引導狀態」上尚有缺漏**。

### 建議下一步需要補齊的 UI 功能：
1. **補藥精靈升級**：全螢幕蓋板內需要動態顯示「該把藥放在第幾號杯子」的圖文引導。
2. **全域警告系統 (Global Alert Banner)**：在網頁最上方預留一個紅色的警告列，用來顯示：
   - 「請確認推桿是否在圓盤下方，並點擊確認」(+ 確認按鈕)
   - 「位置 X 藥杯未被取走」
   - 「蓋子狀態異常」
   - 「尚有空杯未收走」
