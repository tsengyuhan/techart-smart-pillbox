# 蓋子五點感測器 (ADC 分壓) 硬體除錯紀錄

> 建立日期：2026-02-21
> 問題狀態：**待修復 (硬體線路中斷)**

## 1. 異常現象描述

*   **現象 A：** 蓋子上的前兩個感測點（1 號杯與 2 號杯）極度不穩定。無論放不放藥杯，在 `website_control.ino` 讀取到的 ADC 數值經常卡死在 **4095**（滿載，代表 3.3V 開路狀態）。
*   **現象 B：** 使用 `calibration.ino` 進行 ADC 原始數值監看時，在**沒有放任何藥杯**（理論上為斷路，應讀取到被上拉的 3.3V 亦即 4095）的狀態下，讀數卻異常飄移在 **3541** 附近（約 2.8V）。

## 2. 硬體架構與參數配置

1.  **分壓架構：** 利用 5 個不同阻值的電阻串聯對應的單極性霍爾感測器，並聯後加上一顆共同的上拉電阻，統一接至 ESP32 的單一 ADC 腳位（GPIO 4 / Pin 4）。
2.  **電阻配置：**
    *   1 號杯：33kΩ
    *   2 號杯：15kΩ
    *   3 號杯：8.2kΩ
    *   4 號杯：3.9kΩ
    *   5 號杯：2kΩ
3.  **上拉電阻 (R_PULLUP)：** 原始為 4.7kΩ，後經計算為避開 ESP32 大於 3.1V 的 ADC 非線性盲區，**已串聯增加至約 9.4kΩ**。

## 3. 測試與排查過程

為釐清是感測器損壞、磁力不足、程式邏輯錯誤或是線路問題，進行了以下交叉測試：

1.  **更換上拉電阻：** 發現 1 號 (33k) 與 2 號 (15k) 兩路因為阻值過大，在 4.7k 上拉的條件下分壓點極靠近 3.3V (ADC盲區)。將上拉電阻提升至 9.4k 後，理論最高電壓降至 ~2.56V，但 **1 號杯仍然無反應 (卡在 4095)**，排除 ADC 盲區問題。
2.  **更換霍爾感測器與磁鐵互換測試：** 確保磁鐵極性與磁力無誤，且 1 號霍爾感測器已換新，問題依舊。排除感測器本身與磁力問題。
3.  **移除並聯大電容：** 移除並接在訊號線與 GND 之間的 0.1µF 和 10µF 電容，排除硬體 RC 低通濾波造成的 ADC 讀取延遲或漏電問題。問題依舊。
4.  **【關鍵】直接短路測試：** 直接將 1 號分支的 33k 電阻接地（繞過霍爾感測器），**ADC 數值依然毫無反應（不變）**。這證明了該分支並非「未被觸發」，而是「電流根本無法流通」。
5.  **【關鍵】電表導通測試：** 測量 `33k 電阻靠近感測器端` 與 `ESP32 Pin 4` 之間的電阻，**結果為無限大 (1 / OL)**。這確立了該電阻與主訊號線處於物理斷開狀態。
6.  **空載數值異常解析：** 在 `calibration.ino` 中（未開啟內部 pull-up，處於高阻抗 INPUT 模式），空載電壓讀數漂浮在 3541，而非被外部上拉電阻拉高的 4095。這顯示主訊號線 (Pin 4) 連外部的上拉電阻也處於斷開或接觸不良狀態。

## 4. 肇因結論

綜合以上所有硬體特徵與測試結果，可 100% 確定此為**物理接線斷路**問題。

**確切斷路位置：** 位於蓋子背面、被熱熔膠包覆的「中央匯流點」。
該節點原本應連接三方：
1.  通往 ESP32 Pin 4 的藍色主訊號線
2.  通往 3.3V 的上拉電阻 (9.4k)
3.  五組分壓電阻 (33k, 15k, 8.2k, 3.9k, 2k) 的共同端

**現況推斷：** 該銲點已鬆脫、裂開或虛焊。導致 1 號杯 (33k) 等分支未能有效連接至主訊號線，且上拉電阻亦未能將主訊號線穩定拉至 3.3V，使得 Pin 4 形同懸空的「浮接 (Floating) 天線」，讀數完全失去參考價值。

## 5. 建議修復方案

*   **方案 A (正統重焊)：** 小心刮除中央匯流點的熱熔膠，將藍色訊號線、上拉電阻、以及 5 顆分壓電阻的共同接腳重新確實焊接在一起，確保三組電表測量皆導通。
*   **方案 B (外部跳線 Bypassing)：** 若不便移除熱熔膠，可從外部直接拉明線。將 1 號杯 33k 電阻未斷裂的一側（或串聯新電阻）、上拉電阻，直接跳線飛焊至 ESP32 的 Pin 4 及 3.3V 軌道上，繞過熱熔膠內部的損壞節點。

## 6. 最新發現：GPIO 接腳錯置與 GPIO 4 異常 (2026-02-21 晚間更新)

1.  **接腳錯置：** 原本發現訊號線實際上是接到了 **GPIO 5**（在設定裡是單點霍爾感測器的腳位）。這解釋了為何之前測試時，即便 `33k` 斷路，讀數仍呈現 4095。原因是 GPIO 5 該端可能接有其他的上拉電阻，或者該腳位的內部預設狀態使然。
2.  **改回 GPIO 4 後浮接：** 當把訊號線正確改回 **GPIO 4**（程式設定的 `PIN_5_POINT_SENSOR` 和 `PIN_LID`）後，反而出現了**「空載時讀數飄移在 3541」**的狀況。
3.  **這進一步證明了「上拉電阻失效」：** 
    *   如果線路接回 GPIO 4，且那顆 4.7k (或後來的 9.4k) 上拉電阻確實有發揮作用，強勢拉向 3.3V，則讀數絕對會是 4095。
    *   既然只讀到 3541，表示 **GPIO 4 腳位雖然接到那坨熱熔膠，但熱熔膠裡面的上拉電阻也脫落了（或根本沒焊好、接錯線）**。導致 GPIO 4 現在雖然連著 5 顆分壓電阻，但沒有上拉電源，變成一條超級天線。

**👉 最終確認：熱熔膠內的中央匯流點，不僅 1 號杯的 33k 電阻斷開了，連「接往 3.3V 的上拉電阻端」也 100% 斷開或失效。請務必重焊該節點，確保藍色主線、五顆分壓電阻與上拉電阻三方確實接通。**

## 7. 最新進展：主板短路異常 (2026-02-23 晨間更新)

1.  **蓋子線路問題排除：** 經重新處理接線後，透過三用電表測量，蓋子上的分壓線路導通性測試均已通過，中央匯流點斷路問題獲得預期中的修復。
2.  **發現全新硬體致命傷：** 在測試恢復上電時發現，**ESP32-S3 主機板本體的 3.3V 腳位與 GND 腳位出現不明原因的「短路 (相通)」現象**。

### 主板短路影響分析與下一步

ESP32-S3 主板的 3.3V 與 GND 相通是極嚴重的硬體異常，這會導致：
*   **電壓準位歸零：** 所有依賴 3.3V 供電的感測器（包含剛修好線路的蓋子霍爾感測器、溫溼度計等）皆無法獲得工作電壓，形同癱瘓。
*   **ADC 數值異常：** 上拉電阻 (R_PULLUP) 的源頭電壓從 3.3V 變成了 0V。因此，不管蓋子感測器觸發與否，ADC 永遠只會讀到接近 0 的數值。
*   **ESP32 燒毀風險：** 大電流直接對地短路，極有可能導致 ESP32 板載的 LDO (穩壓晶片) 過熱燒毀，甚至主晶片受損。

**🚨 緊急處置與排查建議 (Next Steps)：**
1.  **立即斷電：** 絕對不可以再接上 USB 或外部電源，以免燒毀更多元件。
2.  **隔離測試板子本體：** 
    *   這非常關鍵。請將 **所有連接在 ESP32 上的杜邦線 / 外接模組（全部的感測器、馬達驅動、降壓模組等）通通拔掉**。
    *   讓 ESP32 只剩下一片「空板子」。
    *   再次用三用電表測量空板子上的 3.3V 與 GND。
        *   **如果還是逼逼叫（相通）：** 代表這片 ESP32 板子內部已經擊穿燒毀，或是擴展板（如果有用底板）背面有錫渣短路。您必須更換一片新的 ESP32-S3。
        *   **如果不叫了（正常）：** 恭喜！板子沒壞。這代表短路的兇手是「剛剛插在上面的某個外接模組或是某條電線」。
3.  **抓出外部短路元凶（若板子沒壞）：**
    *   在斷電狀態下，一樣把電表探棒固定在主板的 3.3V 與 GND。
    *   開始「一個一個」把剛剛拔掉的模組 / 電線插回去。
    *   當插到哪一條線時電表突然「逼逼叫」，那條線或那個模組就是導致整個系統短路的罪魁禍首！
