# 💊 ESP32-S3 智慧藥盒系統規格書 (V1.0)

## 1. 核心硬體規格

* **主控制器**：ESP32-S3 DevKit
* **電源供應**：DC 24V / 5A (為了應付步進馬達啟動電流)
* **通訊協定**：Wi-Fi (2.4GHz) + Firebase Realtime Database
* **控制邏輯**：雙核心非阻塞監控 + 阻塞式馬達控制 (確保動作精準)

---

## 2. 腳位配置表 (Pinout Map)

請務必依照此表接線，這包含了我們除錯後修正的最終定義。

### A. 動力系統 (Motors)

| 元件名稱 | 腳位 (GPIO) | 訊號類型 | 備註 |
| --- | --- | --- | --- |
| **圓盤馬達 (M1) 脈衝** | **13** | Digital Out | 控制轉動步數 |
| **圓盤馬達 (M1) 方向** | **14** | Digital Out | 控制正/反轉 |
| **圓盤馬達 (M1) 啟用** | **21** | Digital Out | **ENA** (LOW=鎖定運作, HIGH=放鬆) |
| **推桿馬達 (M2) 脈衝** | **16** | Digital Out | 控制升降步數 |
| **推桿馬達 (M2) 方向** | **15** | Digital Out | 控制上/下 |

### B. 位置感知系統 (Sensors)

| 元件名稱 | 腳位 (GPIO) | 訊號類型 | 備註 |
| --- | --- | --- | --- |
| **圓盤歸零感測器** | **3** | ADC (類比) | 光遮斷器，偵測圓盤原點 |
| **推桿底部感測器** | **9** | ADC (類比) | 光遮斷器，偵測推桿最低點 |
| **五點藥杯偵測** | **4** | ADC (類比) | **分壓電路**，需並聯 0.1uF 電容 |
| **單點霍爾偵測** | **5** | ADC (類比) | 偵測移動中的載具磁鐵 |

### C. 環境與特效 (Environment & Effects)

| 元件名稱 | 腳位 (GPIO) | 訊號類型 | 備註 |
| --- | --- | --- | --- |
| **散熱風扇** | **10** | Digital Out | 透過繼電器/MOSFET 控制 |
| **DHT22 溫濕度** | **11** | Digital In/Out | 需使用 DHT Library |
| **LED 燈條** | **12** | Digital Out | 氣氛燈開關 |
| **MP3 Player (RX)** | **17** | UART RX | 接模組的 TX |
| **MP3 Player (TX)** | **18** | UART TX | 接模組的 RX |

---

## 3. 控制邏輯詳解

### A. 馬達控制 (安全優先)

* **阻塞式控制 (Blocking)**：為了防止指令衝突，當馬達正在移動（例如轉 200 步）時，程式會進入 `while` 迴圈，暫停接收新的 WiFi 指令，直到動作完成。
* **推桿保護 (M2)**：執行「下降」指令時，會即時檢查 `GPIO 9` (底部感測器)。一旦數值超過門檻 (代表遮擋)，立即強制停止並重設原點。
* **圓盤鎖定 (M1)**：`GPIO 21` 必須保持 `LOW`，否則馬達會脫力（Free run）。

### B. 藥杯辨識 (五點分壓法)

利用不同阻值的電阻並聯，改變總電阻，進而改變 ADC 讀到的電壓值。

* **上拉電阻**：4.7kΩ
* **偵測電阻**：33k, 15k, 8.2k, 3.78k, 1.86k
* **邏輯**：程式讀取 ADC 值 -> 比對 32 種組合的理論值 -> 找出最接近的組合 -> 反推哪幾個位置有杯子。

### C. 雲端通訊 (Firebase)

採用 **雙通道 (Read/Write Separation)** 與 **指令 ID 過濾** 機制。

1. **監控上傳 (Upload)**：
* 路徑：`/pillbox/monitor`
* 頻率：溫度每 3 秒一次，感測器每 0.2 秒偵測 (但在本地端處理，有變動才上傳)。
* 包含：溫度、五點狀態 (`1,0,1...`)、霍爾狀態、**Last Seen 時間戳記** (用於心跳偵測)。


2. **指令接收 (Download)**：
* 路徑：`/pillbox/command`
* 格式：`指令,時間戳記ID` (例如 `M1_CW,1707123456`)
* **防重複機制**：ESP32 會記錄 `lastCommandID`。若收到相同 ID，視為重複指令不執行。
* **清除機制**：執行完畢後，ESP32 會將該路徑寫入 `"done"`，網頁端可藉此確認執行完畢。



---

## 4. 網頁控制介面功能

* **即時儀表板**：
* 顯示 ESP32 連線狀態 (斷線 6 秒後變紅燈)。
* 顯示即時溫度。
* 視覺化顯示 5 個藥杯位置與單點霍爾訊號。


* **手動控制面板**：
* **圓盤**：正轉/反轉 (固定 200 步)。
* **推桿**：上升 (出藥) / 下降 (歸零)。
* **開關**：風扇、LED 燈條。
* **測試**：播放音效。

