# ğŸ’Š ESP32-S3 æ™ºæ…§è—¥ç›’ç³»çµ±è¦æ ¼æ›¸ (V2.0)

## 1. æ ¸å¿ƒç¡¬é«”è¦æ ¼

* **ä¸»æ§åˆ¶å™¨**ï¼šESP32-S3 DevKit
* **é›»æºä¾›æ‡‰**ï¼šDC 24V / 5A (æ­¥é€²é¦¬é”ä¾›é›»)
* **é€šè¨Šå”å®š**ï¼šWi-Fi (2.4GHz) + Firebase Realtime Database
* **æ™‚é–“åŒæ­¥**ï¼šNTP Server (pool.ntp.org)
* **æ§åˆ¶é‚è¼¯**ï¼š
    *   **é›™æ ¸å¿ƒ**ï¼šCore 0 è² è²¬ WiFi/Firebase é€šè¨Šï¼ŒCore 1 è² è²¬é¦¬é”èˆ‡æ„Ÿæ¸¬å™¨æƒæã€‚
    *   **é˜»å¡å¼å‹•ä½œ**ï¼šé¦¬é”ç§»å‹•æ™‚æš«åœæŒ‡ä»¤æ¥æ”¶ã€‚

---

## 2. è…³ä½é…ç½®è¡¨ (Pinout Map)

### A. å‹•åŠ›ç³»çµ± (Motors)

| å…ƒä»¶åç¨± | è…³ä½ (GPIO) | è¨Šè™Ÿé¡å‹ | å‚™è¨» |
| --- | --- | --- | --- |
| **åœ“ç›¤é¦¬é” (M1) è„ˆè¡** | **13** | Digital Out | æ§åˆ¶è½‰å‹•æ­¥æ•¸ |
| **åœ“ç›¤é¦¬é” (M1) æ–¹å‘** | **14** | Digital Out | æ§åˆ¶æ­£/åè½‰ |
| **åœ“ç›¤é¦¬é” (M1) å•Ÿç”¨** | **21** | Digital Out | **ENA** (LOW=é–å®šé‹ä½œ, HIGH=æ”¾é¬†) |
| **æ¨æ¡¿é¦¬é” (M2) è„ˆè¡** | **16** | Digital Out | æ§åˆ¶å‡é™æ­¥æ•¸ |
| **æ¨æ¡¿é¦¬é” (M2) æ–¹å‘** | **15** | Digital Out | æ§åˆ¶ä¸Š/ä¸‹ |

### B. ä½ç½®æ„ŸçŸ¥ç³»çµ± (Sensors)

| å…ƒä»¶åç¨± | è…³ä½ (GPIO) | è¨Šè™Ÿé¡å‹ | å‚™è¨» |
| --- | --- | --- | --- |
| **åœ“ç›¤æ­¸é›¶æ„Ÿæ¸¬å™¨** | **3** | ADC (é¡æ¯”) | å…‰é®æ–·å™¨ï¼Œåµæ¸¬åœ“ç›¤åŸé» |
| **æ¨æ¡¿åº•éƒ¨æ„Ÿæ¸¬å™¨** | **9** | ADC (é¡æ¯”) | å…‰é®æ–·å™¨ï¼Œåµæ¸¬æ¨æ¡¿æœ€ä½é» |
| **è“‹å­è—¥æ¯äº”é»åµæ¸¬** | **4** | ADC (é¡æ¯”) | **åˆ†å£“é›»è·¯**ï¼Œåµæ¸¬è“‹å­ä¸Šæœ‰å¹¾å€‹è—¥æ¯ |
| **å–®é»éœçˆ¾åµæ¸¬** | **5** | ADC (é¡æ¯”) | ä½æ–¼æ¨æ¡¿é ‚ç«¯ï¼Œåµæ¸¬å‡ºè—¥æ˜¯å¦è¢«å–èµ° |
| **é›»å®¹è§¸æ‘¸é–‹é—œ** | **8** | Digital In | **[NEW]** è§¸ç™¼è£œè—¥æ¨¡å¼ (å…¨æ©Ÿæ­¸é›¶) |

### C. ç’°å¢ƒèˆ‡ç‰¹æ•ˆ (Environment & Effects)

| å…ƒä»¶åç¨± | è…³ä½ (GPIO) | è¨Šè™Ÿé¡å‹ | å‚™è¨» |
| --- | --- | --- | --- |
| **æ•£ç†±é¢¨æ‰‡** | **10** | Digital Out | é€éç¹¼é›»å™¨/MOSFET æ§åˆ¶ |
| **DHT22 æº«æ¿•åº¦** | **11** | Digital In/Out | éœ€ä½¿ç”¨ DHT Library |
| **LED ç‡ˆæ¢** | **12** | Digital Out | æ°£æ°›ç‡ˆé–‹é—œ |
| **MP3 Player (RX)** | **17** | UART RX | æ¥æ¨¡çµ„çš„ TX |
| **MP3 Player (TX)** | **18** | UART TX | æ¥æ¨¡çµ„çš„ RX |

---

## 3. æ§åˆ¶é‚è¼¯è©³è§£

### A. é–‹æ©Ÿè‡ªå‹•æµç¨‹ (Startup)
1.  **Wi-Fi é€£ç·š**ï¼šé€£ç·šå¾Œç«‹å³é€é NTP åŒæ­¥æ™‚é–“ã€‚
2.  **è‡ªå‹•æ­¸é›¶**ï¼š
    *   æ¨æ¡¿ä¸‹é™è‡³åº•éƒ¨ (Sensor 9)ã€‚
    *   åœ“ç›¤æ—‹è½‰è‡³åŸé» (Sensor 3)ã€‚
3.  **é€²å…¥å¾…æ©Ÿ**ï¼šæ¨æ¡¿ä¸Šå‡è‡³é ‚ç«¯ (å°ä½å‡ºè—¥å­”)ã€‚

### B. å®šæ™‚å‡ºè—¥æµç¨‹ (Dispensing Flow)
1.  **è§¸ç™¼**ï¼šé¬§é˜æ™‚é–“åˆ° (æª¢æŸ¥ NTP æ™‚é–“)ã€‚
2.  **é–‹å­”**ï¼šæ¨æ¡¿ä¸‹é™åˆ°åº•éƒ¨ã€‚
3.  **é¸æ¯**ï¼šåœ“ç›¤è½‰å‹•åˆ°æŒ‡å®šè—¥æ¯ä½ç½® (é è¨­ç‚ºä¸‹ä¸€å€‹æœ‰è—¥çš„ä½ç½®)ã€‚
4.  **å‡ºè—¥**ï¼šæ¨æ¡¿ä¸Šå‡å°‡è—¥æ¯æ¨å‡ºã€‚
5.  **ç›£æ§å–è—¥**ï¼š(åµæ¸¬æ¨æ¡¿é ‚ç«¯ Sensor 5)
    *   **æ­£å¸¸å–èµ°**ï¼šåµæ¸¬åˆ°ç£éµæ¶ˆå¤± -> ç­‰å¾… 15 ç§’ -> è‡ªå‹•æ­¸é›¶ä¸¦å°å­”ã€‚
    *   **é€¾æ™‚ 2 åˆ†é˜**ï¼šè—¥æ¯é‚„åœ¨ -> æ’­æ”¾æé†’éŸ³æ•ˆã€‚
    *   **é€¾æ™‚ 3 åˆ†é˜**ï¼šè—¥æ¯é‚„åœ¨ -> **å¼·åˆ¶å›æ”¶** (æ¨æ¡¿ä¸‹é™ -> åœ“ç›¤æ­¸é›¶ -> å°å­”)ã€‚

### C. è£œè—¥æ¨¡å¼ (Refill Mode)
*   **è§¸ç™¼**ï¼šè§¸æ‘¸ **GPIO 8** é›»å®¹é–‹é—œã€‚
*   **å‹•ä½œ**ï¼š
    *   æ‰€æœ‰é¬§é˜æš«åœã€‚
    *   æ¨æ¡¿ä¸‹é™æ­¸é›¶ã€‚
    *   åœ“ç›¤æ—‹è½‰æ­¸é›¶ã€‚
    *   (æ­¤æ™‚æ‰€æœ‰æ©Ÿæ§‹éƒ½åœ¨æœ€ä½é»èˆ‡åŸé»ï¼Œæ–¹ä¾¿é–‹å•Ÿè“‹å­è£œè—¥)ã€‚
*   **è§£é™¤**ï¼šå†æ¬¡è§¸æ‘¸é–‹é—œ -> æ¢å¾©å¾…æ©Ÿ (æ¨æ¡¿ä¸Šå‡å°å­”)ã€‚

### D. è“‹å­åµæ¸¬ (Lid Monitor)
*   åˆ©ç”¨ 5 é»åˆ†å£“é›»è·¯åµæ¸¬ç›®å‰è“‹å­ä¸Šæœ‰å¹¾å€‹è—¥æ¯ã€‚
*   ç³»çµ±æœƒå°‡ã€Œåµæ¸¬åˆ°çš„æ•¸é‡ã€èˆ‡ Firebase è¨­å®šçš„ã€Œç›®æ¨™æ•¸é‡ã€æ¯”å°ï¼Œä¸¦é¡¯ç¤ºæ–¼ç¶²é ã€‚

---

## 4. é›²ç«¯é€šè¨Š (Firebase Path)

### ç›£æ§ä¸Šå‚³ (Monitor) -> `ESP32 Upload`
*   `/pillbox/monitor/temp`: æº«åº¦ (æ¯ 3 ç§’)
*   `/pillbox/monitor/cups`: 0,1,0,1,1 (å…§éƒ¨åœ“ç›¤ç‹€æ…‹ - æš«æ™‚ä¿ç•™)
*   `/pillbox/monitor/lid/count`: è“‹å­ä¸Šåµæ¸¬åˆ°çš„è—¥æ¯æ•¸
*   `/pillbox/monitor/lid/target`: è¨­å®šçš„ç›®æ¨™è—¥æ¯æ•¸
*   `/pillbox/monitor/lid/is_match`: æ˜¯å¦ç¬¦åˆ (true/false)
*   `/pillbox/monitor/refill_mode`: æ˜¯å¦åœ¨è£œè—¥æ¨¡å¼ (true/false)
*   `/pillbox/monitor/last_seen`: å¿ƒè·³æ™‚é–“æˆ³è¨˜

### è¨­å®šä¸‹å‚³ (Config) -> `Web Write`
*   `/pillbox/config/alarms_str`: é¬§é˜å­—ä¸² (ä¾‹å¦‚ "08:00,12:00,18:00")
*   `/pillbox/config/target_cups`: ç›®æ¨™è—¥æ¯æ•¸ (Int 0-5)
*   `/pillbox/command`: æ‰‹å‹•æŒ‡ä»¤ (M1_CW, M2_UP, HOME, TEST_DISPENSE...)
